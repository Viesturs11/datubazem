-- ============================================
-- 0. IZDZĒST VECOS OBJEKTUS, JA TĀDI EKISISTĒ
-- ============================================

BEGIN
    EXECUTE IMMEDIATE 'DROP TRIGGER PASUTIJUMI_TRG';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -4080 THEN RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TRIGGER KLIENTI_TRG';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -4080 THEN RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE PASUTIJUMI_SEQ';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -2289 THEN RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE KLIENTI_SEQ';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -2289 THEN RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE PASUTIJUMI CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ADRESES CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE KLIENTI CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

-- ============================================
-- 1. TABULU IZVEIDE
-- ============================================

CREATE TABLE KLIENTI (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    KLIENTA_ID NUMBER UNIQUE,
    KLIENTS VARCHAR2(100),
    C_PEDEJA_PASUTIJUMA_DAT DATE,
    PEDEJO_REIZO_APZINATS_DAT DATE,
    NAV_PASUTIJUSI___3_MEN NUMBER,
    PASUTIJUMA_SUMMA_EIRO NUMBER,
    APZVANITO_KLIENTU_SK NUMBER,
    SARUNATO_KLIENTU_SK NUMBER,
    PRIVATPERSONA_1_VAI_JURIDISKA_PERSONA_2 NUMBER,
    VIDEJAIS_PIRKUMA_APJOMS_EUR NUMBER,
    PASUTIJUMU_BIEZUMS_DIENAS NUMBER,
    MAKSĀJUMU_VEIDI VARCHAR2(50),
    MENEDZERIS VARCHAR2(100)
);

CREATE TABLE ADRESES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    KLIENTA_ID NUMBER,
    TELEFONS VARCHAR2(20),
    ADRESE VARCHAR2(255),
    RAJONS VARCHAR2(100),
    CONSTRAINT fk_adreses_klienta FOREIGN KEY (KLIENTA_ID) REFERENCES KLIENTI(KLIENTA_ID)
);

CREATE TABLE PASUTIJUMI (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    KLIENTA_ID NUMBER,
    PASUTIJUMA_DATUMS DATE,
    SUMMA_EUR NUMBER,
    PRODUKTU_SK NUMBER,
    MAKSĀJUMU_VEIDI VARCHAR2(50),
    PIEGADES_ADRESE VARCHAR2(255),
    STATUSS VARCHAR2(50),
    CONSTRAINT fk_pasutijumi_klienta FOREIGN KEY (KLIENTA_ID) REFERENCES KLIENTI(KLIENTA_ID)
);

-- ============================================
-- 2. SEKVENCES
-- ============================================

CREATE SEQUENCE PASUTIJUMI_SEQ START WITH 1001 INCREMENT BY 1;
CREATE SEQUENCE KLIENTI_SEQ START WITH 1001 INCREMENT BY 1;

-- ============================================
-- 3. TRIGGERI
-- ============================================

CREATE OR REPLACE TRIGGER KLIENTI_TRG
BEFORE INSERT ON KLIENTI
FOR EACH ROW
BEGIN
  IF :NEW.KLIENTA_ID IS NULL THEN
    SELECT KLIENTI_SEQ.NEXTVAL INTO :NEW.KLIENTA_ID FROM DUAL;
  END IF;
END;
/

CREATE OR REPLACE TRIGGER PASUTIJUMI_TRG
BEFORE INSERT ON PASUTIJUMI
FOR EACH ROW
BEGIN
  IF :NEW.ID IS NULL THEN
    SELECT PASUTIJUMI_SEQ.NEXTVAL INTO :NEW.ID FROM DUAL;
  END IF;
END;
/

-- ============================================
-- 4. DATU IELĀDE
-- ============================================

-- KLIENTI
INSERT INTO KLIENTI (
    KLIENTA_ID, KLIENTS, C_PEDEJA_PASUTIJUMA_DAT, PEDEJO_REIZO_APZINATS_DAT,
    NAV_PASUTIJUSI___3_MEN, PASUTIJUMA_SUMMA_EIRO, APZVANITO_KLIENTU_SK,
    SARUNATO_KLIENTU_SK, PRIVATPERSONA_1_VAI_JURIDISKA_PERSONA_2,
    VIDEJAIS_PIRKUMA_APJOMS_EUR, PASUTIJUMU_BIEZUMS_DIENAS,
    MAKSĀJUMU_VEIDI, MENEDZERIS
) VALUES
(1, 'Andris Ozoliņš', DATE '2024-01-13', NULL, 0, 125.0, 1, 1, 1, 35.0, 35.0, 'Kredītkarte', 'Janis Loks');

INSERT INTO KLIENTI (
    KLIENTA_ID, KLIENTS, C_PEDEJA_PASUTIJUMA_DAT, PEDEJO_REIZO_APZINATS_DAT,
    NAV_PASUTIJUSI___3_MEN, PASUTIJUMA_SUMMA_EIRO, APZVANITO_KLIENTU_SK,
    SARUNATO_KLIENTU_SK, PRIVATPERSONA_1_VAI_JURIDISKA_PERSONA_2,
    VIDEJAIS_PIRKUMA_APJOMS_EUR, PASUTIJUMU_BIEZUMS_DIENAS,
    MAKSĀJUMU_VEIDI, MENEDZERIS
) VALUES
(2, 'Kristīne Kalniņa', DATE '2024-01-13', NULL, 0, 98.0, 1, 1, 1, 45.0, 45.0, 'Kredītkarte', 'Janis Loks');

INSERT INTO KLIENTI (
    KLIENTA_ID, KLIENTS, C_PEDEJA_PASUTIJUMA_DAT, PEDEJO_REIZO_APZINATS_DAT,
    NAV_PASUTIJUSI___3_MEN, PASUTIJUMA_SUMMA_EIRO, APZVANITO_KLIENTU_SK,
    SARUNATO_KLIENTU_SK, PRIVATPERSONA_1_VAI_JURIDISKA_PERSONA_2,
    VIDEJAIS_PIRKUMA_APJOMS_EUR, PASUTIJUMU_BIEZUMS_DIENAS,
    MAKSĀJUMU_VEIDI, MENEDZERIS
) VALUES
(3, 'Jānis Bērziņš', DATE '2024-03-28', NULL, 20, 156.0, 1, 1, 1, 62.0, 62.0, 'Kredītkarte', 'Peteris Sirmais');

INSERT INTO KLIENTI (
    KLIENTA_ID, KLIENTS, C_PEDEJA_PASUTIJUMA_DAT, PEDEJO_REIZO_APZINATS_DAT,
    NAV_PASUTIJUSI___3_MEN, PASUTIJUMA_SUMMA_EIRO, APZVANITO_KLIENTU_SK,
    SARUNATO_KLIENTU_SK, PRIVATPERSONA_1_VAI_JURIDISKA_PERSONA_2,
    VIDEJAIS_PIRKUMA_APJOMS_EUR, PASUTIJUMU_BIEZUMS_DIENAS,
    MAKSĀJUMU_VEIDI, MENEDZERIS
) VALUES
(4, 'Laura Vītola', DATE '2023-07-20', NULL, 277, 87.0, 1, 1, 1, 78.0, 78.0, 'Skaidra nauda', 'Janis Loks');

INSERT INTO KLIENTI (
    KLIENTA_ID, KLIENTS, C_PEDEJA_PASUTIJUMA_DAT, PEDEJO_REIZO_APZINATS_DAT,
    NAV_PASUTIJUSI___3_MEN, PASUTIJUMA_SUMMA_EIRO, APZVANITO_KLIENTU_SK,
    SARUNATO_KLIENTU_SK, PRIVATPERSONA_1_VAI_JURIDISKA_PERSONA_2,
    VIDEJAIS_PIRKUMA_APJOMS_EUR, PASUTIJUMU_BIEZUMS_DIENAS,
    MAKSĀJUMU_VEIDI, MENEDZERIS
) VALUES
(5, 'Mārtiņš Liepiņš', DATE '2023-07-20', NULL, 291, 142.0, 1, 1, 1, 22.0, 22.0, 'Skaidra nauda', 'Peteris Sirmais');

-- ADRESES
INSERT INTO ADRESES (ID, KLIENTA_ID, TELEFONS, ADRESE, RAJONS) VALUES
(1, 1, '26594912', 'Brīvības iela 45-12, Rīga, LV-1011', 'Centrs');
INSERT INTO ADRESES (ID, KLIENTA_ID, TELEFONS, ADRESE, RAJONS) VALUES
(2, 2, '26018473', 'Meža prospekts 17-3, Rīga, LV-1014', 'Mežaparks');
INSERT INTO ADRESES (ID, KLIENTA_ID, TELEFONS, ADRESE, RAJONS) VALUES
(3, 3, '26957284', 'K. Valdemāra iela 10-5, Rīga, LV-1010', 'Centrs');
INSERT INTO ADRESES (ID, KLIENTA_ID, TELEFONS, ADRESE, RAJONS) VALUES
(4, 4, '26730519', 'Lielvārdes iela 21-8, Rīga, LV-1006', 'Teika');
INSERT INTO ADRESES (ID, KLIENTA_ID, TELEFONS, ADRESE, RAJONS) VALUES
(5, 5, '26248793', 'Tērbatas iela 89-4, Rīga, LV-1001', 'Centrs');

-- PASUTIJUMI
INSERT INTO PASUTIJUMI (
    ID, KLIENTA_ID, PASUTIJUMA_DATUMS, SUMMA_EUR, PRODUKTU_SK,
    MAKSĀJUMU_VEIDI, PIEGADES_ADRESE, STATUSS
) VALUES
(1, 1, DATE '2024-01-13', 125, 3, 'Kredītkarte', 'Brīvības iela 45-12, Rīga', 'Apmaksāts');
INSERT INTO PASUTIJUMI (
    ID, KLIENTA_ID, PASUTIJUMA_DATUMS, SUMMA_EUR, PRODUKTU_SK,
    MAKSĀJUMU_VEIDI, PIEGADES_ADRESE, STATUSS
) VALUES
(2, 2, DATE '2024-01-13', 98, 2, 'Kredītkarte', 'Meža prospekts 17-3, Rīga', 'Apmaksāts');
INSERT INTO PASUTIJUMI (
    ID, KLIENTA_ID, PASUTIJUMA_DATUMS, SUMMA_EUR, PRODUKTU_SK,
    MAKSĀJUMU_VEIDI, PIEGADES_ADRESE, STATUSS
) VALUES
(3, 3, DATE '2024-03-28', 156, 4, 'Kredītkarte', 'K. Valdemāra iela 10-5, Rīga', 'Apmaksāts');
INSERT INTO PASUTIJUMI (
    ID, KLIENTA_ID, PASUTIJUMA_DATUMS, SUMMA_EUR, PRODUKTU_SK,
    MAKSĀJUMU_VEIDI, PIEGADES_ADRESE, STATUSS
) VALUES
(4, 4, DATE '2023-07-20', 87, 1, 'Skaidra nauda', 'Lielvārdes iela 21-8, Rīga', 'Apmaksāts');
INSERT INTO PASUTIJUMI (
    ID, KLIENTA_ID, PASUTIJUMA_DATUMS, SUMMA_EUR, PRODUKTU_SK,
    MAKSĀJUMU_VEIDI, PIEGADES_ADRESE, STATUSS
) VALUES
(5, 5, DATE '2023-07-20', 142, 2, 'Skaidra nauda', 'Tērbatas iela 89-4, Rīga', 'Apmaksāts');

-- ============================================
-- 5. PROCEDŪRA: ATJAUNO_PASTUTITAJUS
-- ============================================

CREATE OR REPLACE PROCEDURE ATJAUNO_PASTUTITAJUS AS
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE MAZIEPASTUTITAJI';
    EXCEPTION WHEN OTHERS THEN NULL;
    END;

    BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE LIELIEPASTUTITAJI';
    EXCEPTION WHEN OTHERS THEN NULL;
    END;

    EXECUTE IMMEDIATE '
        CREATE TABLE MAZIEPASTUTITAJI AS
        SELECT * FROM KLIENTI
        WHERE NAV_PASUTIJUSI___3_MEN > 90
    ';

    EXECUTE IMMEDIATE '
        CREATE TABLE LIELIEPASTUTITAJI AS
        SELECT * FROM KLIENTI
        WHERE NAV_PASUTIJUSI___3_MEN <= 90
    ';
END;
/

BEGIN
    ATJAUNO_PASTUTITAJUS;
END;
/